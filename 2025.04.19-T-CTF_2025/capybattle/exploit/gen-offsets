#!/bin/sh
set -e -u -x
target=../buildroot/output/target
libc=$target/lib64/libc.so
exe=$target/bin/execve_monitor
ROPgadget --binary="$libc" >rop.txt
nm -D "$libc" >nm.txt
objdump -d "$exe" >exe.txt
echo "// libc.so"
echo "#define POP_RDI_RET $(grep ': pop rdi ; ret$' rop.txt | head -1 | awk '{print $1}')"
echo "#define POP_RSI_RET $(grep ': pop rsi ; ret$' rop.txt | head -1 | awk '{print $1}')"
echo "#define POP_RDX_RET $(grep ': pop rdx ; ret$' rop.txt | head -1 | awk '{print $1}')"
echo "#define EXECVE 0x$(grep 'T execve$' nm.txt | head -1 | awk '{print $1}')"
echo "#define RET $(grep ': ret$' rop.txt | head -1 | awk '{print $1}')"
echo ""
echo "// execve_monitor: handle_event_1()"
echo "#define LOCALS_SIZE 0x2218"
echo "#define EVENT_OFFSET 0"
echo "#define COOKIE_OFFSET 0x2208"
echo "#define PTRPTR_MINUS_EVENT 0x838"
echo "#define PTR_MINUS_EVENT 0xc30"
echo ""
echo "// libbpf.so"
echo "#define RET_FROM_HANDLE_EVENT 0x3a2ff"
echo "#define SIZEOF_LIBBPF 0x67000"
